<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø±Ø§ÙÙ‚ - Ø·ÙÙ„Ùƒ ÙÙŠ Ø£ÙŠØ§Ø¯ÙŠ Ø¢Ù…Ù†Ø©</title>
    
    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #1e293b;
            --neon-green: #39ff14;
            --accent-color: #10b981;
            --gold: #f59e0b;
            --bg-light: #f8fafc;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-light);
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }
        html[lang="fr"] body { font-family: 'Roboto', sans-serif; }
        main { flex: 1; }

        /* UI Components */
        .hero-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 50px 0; text-align: center;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); margin-bottom: 30px;
        }
        .neon-text {
            font-size: 3rem; font-weight: 900; color: #fff;
            text-shadow: 0 0 10px rgba(57, 255, 20, 0.5); margin-bottom: 5px;
        }
        .subtitle { color: #cbd5e1; font-size: 1.1rem; letter-spacing: 1px; font-weight: 300; }
        .custom-card {
            background: white; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; overflow: hidden;
        }
        .role-selector {
            cursor: pointer; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; transition: all 0.2s; background: #fff;
        }
        .role-selector.active { border-color: var(--accent-color); background-color: #ecfdf5; }
        .view-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Table */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tbody tr { display: block; background: white; margin-bottom: 15px; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
            .mobile-table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; border-bottom: 1px dashed #eee; }
            .mobile-table td:last-child { border-bottom: none; }
            .mobile-table td::before { content: attr(data-label); font-weight: bold; color: #64748b; font-size: 0.9rem; }
        }

        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .profile-img-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid var(--accent-color); }
        .star-rating i { color: #e2e8f0; cursor: pointer; transition: color 0.2s; font-size: 1.5rem; }
        .star-rating i.active { color: var(--gold); }
        .app-footer { background-color: #fff; border-top: 1px solid #eee; padding: 30px 0; margin-top: auto; }
        .footer-link { color: #64748b; text-decoration: none; margin: 0 10px; font-size: 0.9rem; cursor: pointer; }
        .footer-link:hover { color: var(--primary-color); text-decoration: underline; }
        .admin-stat-card { border-left: 4px solid var(--primary-color); }
        .lang-btn { font-weight: bold; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .lang-btn:hover { background: var(--primary-color); color: #fff; }

        /* Caregiver Stats Cards */
        .cg-stat-card { border-radius: 12px; padding: 15px; color: white; margin-bottom: 15px; text-align: center; }
        .cg-stat-total { background: linear-gradient(45deg, #3b82f6, #2563eb); }
        .cg-stat-pending { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .cg-stat-accepted { background: linear-gradient(45deg, #10b981, #059669); }
        .cg-stat-rejected { background: linear-gradient(45deg, #ef4444, #dc2626); }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-dark d-flex align-items-center" href="#" onclick="location.reload()">
                <i class="bi bi-balloon-heart-fill text-success me-2 fs-4"></i> <span data-i18n="app_name">Ù…Ø±Ø§ÙÙ‚</span>
            </a>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm lang-btn rounded-pill" onclick="toggleLanguage()" id="langSwitcher">FR</button>
                <button id="editProfileBtn" class="btn btn-outline-primary btn-sm d-none rounded-pill" onclick="openEditProfileModal()">
                    <i class="bi bi-gear-fill"></i> <span class="d-none d-md-inline" data-i18n="settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                </button>
                <span id="userInfo" class="text-secondary small fw-bold d-none d-md-block mx-2"></span>
                <button id="logoutBtn" class="btn btn-light btn-sm text-danger border d-none fw-bold rounded-pill" onclick="logout()">
                    <i class="bi bi-box-arrow-left"></i> <span class="d-none d-md-inline" data-i18n="logout">Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </div>
    </nav>

    <main>
        <!-- 1. AUTH SCREEN -->
        <section id="authView" class="view-section active">
            <header class="hero-header">
                <div class="container">
                    <h1 class="neon-text" data-i18n="app_name">Ù…Ø±Ø§ÙÙ‚</h1>
                    <p class="subtitle" data-i18n="slogan">Ø·ÙÙ„Ùƒ ÙÙŠ Ø£ÙŠØ§Ø¯ÙŠ Ø¢Ù…Ù†Ø©</p>
                </div>
            </header>

            <div class="container pb-5">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-5">
                        <div class="custom-card p-4">
                            <ul class="nav nav-pills mb-4 nav-justified p-1 bg-light rounded-pill" role="tablist">
                                <li class="nav-item"><button class="nav-link active rounded-pill" data-bs-toggle="pill" data-bs-target="#login-content" data-i18n="login">Ø¯Ø®ÙˆÙ„</button></li>
                                <li class="nav-item"><button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#register-content" data-i18n="register">Ø¬Ø¯ÙŠØ¯</button></li>
                            </ul>
                            
                            <div class="tab-content">
                                <!-- Login -->
                                <div class="tab-pane fade show active" id="login-content">
                                    <form id="loginForm">
                                        <div class="mb-3"><input type="text" class="form-control" id="loginEmail" required data-i18n-placeholder="email_placeholder" autocapitalize="off" spellcheck="false"></div>
                                        <div class="mb-2"><input type="password" class="form-control" id="loginPass" required data-i18n-placeholder="password_placeholder" autocapitalize="off"></div>
                                        <div class="text-end mb-4"><a href="#" class="text-decoration-none small text-muted" onclick="openForgotPassModal()" data-i18n="forgot_password">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a></div>
                                        <button type="submit" class="btn btn-primary w-100 py-2 rounded-3 fw-bold shadow-sm" data-i18n="login_btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                                    </form>
                                    <div class="mt-4 text-center p-3 bg-light rounded small text-muted border border-dashed">
                                        <strong data-i18n="demo_accounts">ğŸ…¼ğŸ…¾ğŸ†ğŸ…°ğŸ…µğŸ…¸ğŸ…º</strong><br>
                                        
                                    </div>
                                </div>
                                <!-- Register -->
                                <div class="tab-pane fade" id="register-content">
                                    <form id="registerForm">
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <div class="role-selector text-center active" onclick="selectRole('parent', this)">
                                                    <i class="bi bi-person-fill fs-3 text-primary"></i> <div class="small fw-bold mt-1" data-i18n="role_parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="role-selector text-center" onclick="selectRole('caregiver', this)">
                                                    <i class="bi bi-heart-pulse-fill fs-3 text-danger"></i> <div class="small fw-bold mt-1" data-i18n="role_caregiver">Ù…Ø±Ø§ÙÙ‚Ø©</div>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="regRole" value="parent">
                                        <div class="mb-2"><input type="text" class="form-control" id="regName" data-i18n-placeholder="fullname" required></div>
                                        <div class="mb-2"><input type="email" class="form-control" id="regEmail" data-i18n-placeholder="email_placeholder" required autocapitalize="off"></div>
                                        <div class="mb-2"><input type="tel" class="form-control" id="regPhone" data-i18n-placeholder="phone" required></div>
                                        <div class="mb-2"><input type="password" class="form-control" id="regPass" data-i18n-placeholder="password_placeholder" required autocapitalize="off"></div>
                                        <div class="mb-2">
                                            <select class="form-select dynamic-wilaya" id="regWilaya" required>
                                                <!-- Populated by JS -->
                                            </select>
                                        </div>
                                        <div id="caregiverFields" class="d-none mt-3 p-3 bg-light rounded border">
                                            <div class="mb-2">
                                                <select class="form-select dynamic-service" id="regService">
                                                    <!-- Populated by JS -->
                                                </select>
                                            </div>
                                            <div class="mb-0"><label class="small fw-bold" data-i18n="upload_cert">Ø±ÙØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (PDF)</label><input type="file" class="form-control" id="regCert" accept=".pdf"></div>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100 mt-3 py-2 fw-bold" data-i18n="create_account_btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. PARENT VIEW -->
        <section id="parentView" class="view-section">
            <div class="container py-4">
                <h4 class="fw-bold text-primary mb-4"><i class="bi bi-search"></i> <span data-i18n="search_title">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø§ÙÙ‚Ø©</span></h4>
                <div class="custom-card p-3 mb-4">
                    <div class="row g-2">
                        <div class="col-6 col-md-3"><select class="form-select dynamic-wilaya" id="searchWilaya"><option value="Ø§Ù„ÙƒÙ„" data-i18n="all_wilayas">ÙƒÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª</option><!-- JS --></select></div>
                        <div class="col-6 col-md-3"><select class="form-select dynamic-service" id="searchService"><option value="Ø§Ù„ÙƒÙ„" data-i18n="all_services">ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option><!-- JS --></select></div>
                        <div class="col-8 col-md-4"><input type="number" class="form-control" id="searchAge" data-i18n-placeholder="child_age"></div>
                        <div class="col-4 col-md-2"><button class="btn btn-primary w-100 fw-bold" onclick="performSearch()" data-i18n="search_btn">Ø¨Ø­Ø«</button></div>
                    </div>
                </div>
                <div class="row g-3 mb-5" id="resultsArea"></div>
                <h5 class="fw-bold border-bottom pb-2 mb-3" data-i18n="my_requests">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h5>
                <div class="custom-card p-0"><table class="table table-hover mb-0 mobile-table"><thead class="table-light"><tr><th data-i18n="th_caregiver">Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø©</th><th data-i18n="th_service">Ø§Ù„Ø®Ø¯Ù…Ø©</th><th data-i18n="th_status">Ø§Ù„Ø­Ø§Ù„Ø©</th><th data-i18n="th_action">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="myRequestsTable"></tbody></table></div>
            </div>
        </section>

        <!-- 3. CAREGIVER VIEW -->
        <section id="caregiverView" class="view-section">
            <div class="container py-4">
                <!-- Profile Card & Availability -->
                <div class="custom-card p-3 mb-4 d-flex align-items-center bg-white border-start border-4 border-success">
                    <img id="dashboardProfileImg" src="" width="70" height="70" class="rounded-circle bg-light border p-1 me-3 object-fit-cover">
                    <div class="flex-grow-1">
                        <h5 class="mb-1 fw-bold" id="cgNameProfile"></h5>
                        <div class="small-stars mb-1" id="cgRatingProfile"></div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="availabilityToggle" onchange="toggleAvailability()">
                            <label class="form-check-label fw-bold small" for="availabilityToggle" id="availabilityLabel" data-i18n="status_online">Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        </div>
                    </div>
                    <div><button class="btn btn-outline-dark btn-sm rounded-pill" onclick="openEditProfileModal()"><i class="bi bi-pencil"></i> <span data-i18n="edit">ØªØ¹Ø¯ÙŠÙ„</span></button></div>
                </div>

                <!-- Stats Dashboard -->
                <div class="row mb-3">
                    <div class="col-6 col-md-3"><div class="cg-stat-card cg-stat-total"><h3 class="fw-bold mb-0" id="cgStatTotal">0</h3><small data-i18n="stat_total_req">Ø§Ù„ÙƒÙ„</small></div></div>
                    <div class="col-6 col-md-3"><div class="cg-stat-card cg-stat-pending"><h3 class="fw-bold mb-0" id="cgStatPending">0</h3><small data-i18n="stat_new_req">Ø§Ù†ØªØ¸Ø§Ø±</small></div></div>
                    <div class="col-6 col-md-3"><div class="cg-stat-card cg-stat-accepted"><h3 class="fw-bold mb-0" id="cgStatAccepted">0</h3><small data-i18n="stat_accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</small></div></div>
                    <div class="col-6 col-md-3"><div class="cg-stat-card cg-stat-rejected"><h3 class="fw-bold mb-0" id="cgStatRejected">0</h3><small data-i18n="stat_rejected">Ù…Ø±ÙÙˆØ¶Ø©</small></div></div>
                </div>

                <h5 class="fw-bold mb-3"><i class="bi bi-inbox-fill text-primary"></i> <span data-i18n="incoming_requests">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</span></h5>
                <div class="custom-card p-0"><table class="table mb-0 mobile-table align-middle"><thead class="table-light"><tr><th data-i18n="th_parent">Ø§Ù„ÙˆÙ„ÙŠ</th><th data-i18n="th_child">Ø§Ù„Ø·ÙÙ„</th><th data-i18n="th_details">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th data-i18n="th_days">Ø§Ù„Ø£ÙŠØ§Ù…</th><th data-i18n="th_action">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="incomingRequestsTable"></tbody></table></div>
            </div>
        </section>

        <!-- 4. ADMIN VIEW -->
        <section id="adminView" class="view-section">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12 py-4">
                        <h3 class="fw-bold mb-4 text-primary" data-i18n="admin_panel">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… <span class="badge bg-danger fs-6">Admin</span></h3>
                        
                        <!-- Top Stats -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3"><div class="custom-card p-3 admin-stat-card border-primary"><h6 class="text-muted small" data-i18n="stat_users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h6><h3 class="fw-bold mb-0" id="statTotalUsers">0</h3></div></div>
                            <div class="col-md-3"><div class="custom-card p-3 admin-stat-card border-success"><h6 class="text-muted small" data-i18n="stat_caregivers">Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª</h6><h3 class="fw-bold mb-0" id="statCaregivers">0</h3></div></div>
                            <div class="col-md-3"><div class="custom-card p-3 admin-stat-card border-warning"><h6 class="text-muted small" data-i18n="stat_reports">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h6><h3 class="fw-bold mb-0" id="statReportsCount">0</h3></div></div>
                        </div>

                        <!-- Professional Dashboard Sections: Successful Caregivers & Daily Transactions -->
                        <div class="row g-4 mb-4">
                            <!-- Successful Caregivers -->
                            <div class="col-lg-5">
                                <div class="custom-card h-100 p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="fw-bold mb-0 text-success"><i class="bi bi-trophy-fill"></i> <span data-i18n="successful_caregivers">Ø£Ù†Ø¬Ø­ Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª</span></h5>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-borderless align-middle mb-0">
                                            <tbody id="adminTopCaregivers">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!-- Daily Transactions -->
                            <div class="col-lg-7">
                                <div class="custom-card h-100 p-4">
                                    <h5 class="fw-bold mb-3 text-primary"><i class="bi bi-graph-up-arrow"></i> <span data-i18n="daily_transactions">Ø§Ù„ØªØ¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span></h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th data-i18n="th_parent">Ø§Ù„ÙˆÙ„ÙŠ</th>
                                                    <th data-i18n="th_caregiver">Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø©</th>
                                                    <th data-i18n="th_status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="adminDailyTrans">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Management -->
                        <div class="custom-card p-4 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="fw-bold mb-0"><i class="bi bi-people-fill"></i> <span data-i18n="manage_users">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></h5>
                                <input type="text" class="form-control w-50" id="adminSearch" data-i18n-placeholder="search_placeholder" onkeyup="loadAdminDashboard()">
                            </div>
                            <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th data-i18n="th_name">Ø§Ù„Ø§Ø³Ù…</th><th data-i18n="th_role">Ø§Ù„Ù†ÙˆØ¹</th><th data-i18n="phone">Ø§Ù„Ù‡Ø§ØªÙ</th><th>Email</th><th class="text-danger">Pass</th><th data-i18n="th_status">Ø§Ù„Ø­Ø§Ù„Ø©</th><th data-i18n="th_action">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="adminUsersTable"></tbody></table></div>
                        </div>

                        <!-- Reports -->
                        <div class="custom-card p-4 mb-4">
                            <h5 class="fw-bold mb-3"><i class="bi bi-envelope-exclamation-fill"></i> <span data-i18n="reports_messages">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</span></h5>
                            <div class="table-responsive"><table class="table table-striped"><thead class="table-dark"><tr><th data-i18n="sender">Ø§Ù„Ù…Ø±Ø³Ù„</th><th data-i18n="type">Ø§Ù„Ù†ÙˆØ¹</th><th data-i18n="message">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th data-i18n="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody id="adminReportsTable"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer class="app-footer">
        <div class="container text-center">
            <h5 class="fw-bold text-dark mb-3" data-i18n="app_name">Ù…Ø±Ø§ÙÙ‚</h5>
            <div class="mb-4">
                <span class="footer-link" onclick="openModal('aboutModal')" data-i18n="about_us">Ù…Ù† Ù†Ø­Ù†</span>
                <span class="footer-link" onclick="openModal('privacyModal')" data-i18n="privacy_policy">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span>
                <span class="footer-link" onclick="openModal('contactModal')" data-i18n="contact_us">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</span>
            </div>
            <button class="btn btn-sm btn-outline-danger rounded-pill mb-3" onclick="openModal('reportModal')"><i class="bi bi-exclamation-triangle"></i> <span data-i18n="report_issue">Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</span></button>
            <p class="small text-muted mb-0" data-i18n="copyright">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2024</p>
        </div>
    </footer>

    <!-- ================= MODALS ================= -->
    <div class="modal fade" id="aboutModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" data-i18n="about_us">Ù…Ù† Ù†Ø­Ù†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p data-i18n="about_text">Ù…Ù†ØµØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø±Ù‚Ù…ÙŠØ©...</p></div></div></div></div>
    <div class="modal fade" id="privacyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" data-i18n="privacy_policy">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p data-i18n="privacy_text">Ù†Ø­Ù† Ù†Ø­ØªØ±Ù… Ø®ØµÙˆØµÙŠØªÙƒÙ…...</p></div></div></div></div>
    <div class="modal fade" id="contactModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" data-i18n="contact_us">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="submitReport(event, 'Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©')"><div class="mb-3"><label data-i18n="name">Ø§Ù„Ø§Ø³Ù…</label><input type="text" class="form-control" required></div><div class="mb-3"><label data-i18n="message">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label><textarea class="form-control" rows="4" required></textarea></div><button type="submit" class="btn btn-primary w-100" data-i18n="send">Ø¥Ø±Ø³Ø§Ù„</button></form></div></div></div></div>
    <div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title" data-i18n="report_issue">Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="submitReport(event, 'Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©')"><div class="mb-3"><label data-i18n="issue_details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label><textarea class="form-control" rows="4" required></textarea></div><button type="submit" class="btn btn-danger w-100" data-i18n="send_report">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button></form></div></div></div></div>
    <div class="modal fade" id="forgotPassModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" data-i18n="recover_pass">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-muted" data-i18n="recover_hint">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.</p><input type="email" id="forgotEmail" class="form-control mb-3"><button onclick="handleForgotPass()" class="btn btn-primary w-100" data-i18n="send">Ø¥Ø±Ø³Ø§Ù„</button></div></div></div></div>
    <div class="modal fade" id="requestModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header bg-primary text-white"><h5 class="modal-title" data-i18n="request_service">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="sendRequestForm"><input type="hidden" id="targetCaregiverId"><div class="mb-3"><label class="form-label small fw-bold" data-i18n="child_name">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label><input type="text" class="form-control" id="reqChildName" required></div><div class="row"><div class="col-6 mb-3"><label class="form-label small fw-bold" data-i18n="child_age">Ø§Ù„Ø¹Ù…Ø±</label><input type="number" class="form-control" id="reqChildAge" required></div><div class="col-6 mb-3"><label class="form-label small fw-bold" data-i18n="duration">Ø§Ù„Ù…Ø¯Ø©</label><select class="form-select" id="reqDuration"><option value="Ø´Ù‡Ø±" data-i18n="1_month">Ø´Ù‡Ø±</option><option value="3 Ø£Ø´Ù‡Ø±" data-i18n="3_months">3 Ø£Ø´Ù‡Ø±</option><option value="Ø³Ù†Ø©" data-i18n="1_year">Ø³Ù†Ø©</option></select></div></div><div class="mb-3"><label class="form-label small fw-bold" data-i18n="days">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©</label><input type="text" class="form-control" id="reqDays" required></div><button type="submit" class="btn btn-primary w-100 fw-bold" data-i18n="confirm_send">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„</button></form></div></div></div></div>
    <div class="modal fade" id="editProfileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header bg-dark text-white"><h5 class="modal-title" data-i18n="edit_profile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="editProfileForm"><div class="text-center mb-3"><div class="position-relative d-inline-block"><img id="editImgPreview" src="" class="profile-img-preview"><label for="editProfilePic" class="position-absolute bottom-0 start-0 bg-primary text-white p-1 rounded-circle" style="cursor: pointer;"><i class="bi bi-camera-fill small"></i></label></div><input type="file" id="editProfilePic" class="d-none" accept="image/*"></div><div class="mb-3"><label class="form-label small fw-bold" data-i18n="fullname">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" class="form-control" id="editName" required></div><div class="mb-3"><label class="form-label small fw-bold" data-i18n="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" class="form-control" id="editPhone" required></div><div class="mb-3"><label class="form-label small fw-bold" data-i18n="wilaya">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label><select class="form-select dynamic-wilaya" id="editWilaya" required></select></div><div class="bg-light p-3 rounded mb-3 border"><h6 class="text-danger small fw-bold mb-2" data-i18n="change_pass">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h6><input type="password" class="form-control form-control-sm" id="editNewPass" autocapitalize="off"></div><div id="caregiverEditFields" class="d-none pt-2"><h6 class="text-primary fw-bold mb-2" data-i18n="pro_info">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù†ÙŠØ©</h6><div class="mb-2"><select class="form-select dynamic-service" id="editService"></select></div></div><button type="submit" class="btn btn-success w-100 fw-bold mt-2" data-i18n="save">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button></form></div></div></div></div>
    <div class="modal fade" id="rateModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header bg-warning text-dark"><h5 class="modal-title" data-i18n="rate_caregiver">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø©</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><h6 id="rateCgName" class="mb-3"></h6><div class="star-rating mb-3 d-flex justify-content-center gap-2" id="starContainer"><i class="bi bi-star-fill" data-val="1"></i><i class="bi bi-star-fill" data-val="2"></i><i class="bi bi-star-fill" data-val="3"></i><i class="bi bi-star-fill" data-val="4"></i><i class="bi bi-star-fill" data-val="5"></i></div><input type="hidden" id="ratingValue" value="0"><input type="hidden" id="rateRequestId"><input type="hidden" id="rateCaregiverId"><div class="mb-3"><textarea id="rateComment" class="form-control" rows="3"></textarea></div><button onclick="submitReview()" class="btn btn-dark w-100" data-i18n="publish">Ù†Ø´Ø±</button></div></div></div></div>
    <div class="modal fade" id="reviewsListModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content border-0 shadow"><div class="modal-header bg-light"><h5 class="modal-title" data-i18n="reviews">Ø§Ù„Ø¢Ø±Ø§Ø¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="reviewsListBody"></div></div></div></div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- DATA CONSTANTS (58 Wilayas + New Services) ---
        const wilayas = [
            {id:1, ar:"Ø£Ø¯Ø±Ø§Ø±", fr:"Adrar"}, {id:2, ar:"Ø§Ù„Ø´Ù„Ù", fr:"Chlef"}, {id:3, ar:"Ø§Ù„Ø£ØºÙˆØ§Ø·", fr:"Laghouat"}, {id:4, ar:"Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", fr:"Oum El Bouaghi"},
            {id:5, ar:"Ø¨Ø§ØªÙ†Ø©", fr:"Batna"}, {id:6, ar:"Ø¨Ø¬Ø§ÙŠØ©", fr:"BÃ©jaÃ¯a"}, {id:7, ar:"Ø¨Ø³ÙƒØ±Ø©", fr:"Biskra"}, {id:8, ar:"Ø¨Ø´Ø§Ø±", fr:"BÃ©char"},
            {id:9, ar:"Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", fr:"Blida"}, {id:10, ar:"Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", fr:"Bouira"}, {id:11, ar:"ØªÙ…Ù†Ø±Ø§Ø³Øª", fr:"Tamanrasset"}, {id:12, ar:"ØªØ¨Ø³Ø©", fr:"TÃ©bessa"},
            {id:13, ar:"ØªÙ„Ù…Ø³Ø§Ù†", fr:"Tlemcen"}, {id:14, ar:"ØªÙŠØ§Ø±Øª", fr:"Tiaret"}, {id:15, ar:"ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", fr:"Tizi Ouzou"}, {id:16, ar:"Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", fr:"Alger"},
            {id:17, ar:"Ø§Ù„Ø¬Ù„ÙØ©", fr:"Djelfa"}, {id:18, ar:"Ø¬ÙŠØ¬Ù„", fr:"Jijel"}, {id:19, ar:"Ø³Ø·ÙŠÙ", fr:"SÃ©tif"}, {id:20, ar:"Ø³Ø¹ÙŠØ¯Ø©", fr:"SaÃ¯da"},
            {id:21, ar:"Ø³ÙƒÙŠÙƒØ¯Ø©", fr:"Skikda"}, {id:22, ar:"Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", fr:"Sidi Bel AbbÃ¨s"}, {id:23, ar:"Ø¹Ù†Ø§Ø¨Ø©", fr:"Annaba"}, {id:24, ar:"Ù‚Ø§Ù„Ù…Ø©", fr:"Guelma"},
            {id:25, ar:"Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", fr:"Constantine"}, {id:26, ar:"Ø§Ù„Ù…Ø¯ÙŠØ©", fr:"MÃ©dÃ©a"}, {id:27, ar:"Ù…Ø³ØªØºØ§Ù†Ù…", fr:"Mostaganem"}, {id:28, ar:"Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", fr:"M'Sila"},
            {id:29, ar:"Ù…Ø¹Ø³ÙƒØ±", fr:"Mascara"}, {id:30, ar:"ÙˆØ±Ù‚Ù„Ø©", fr:"Ouargla"}, {id:31, ar:"ÙˆÙ‡Ø±Ø§Ù†", fr:"Oran"}, {id:32, ar:"Ø§Ù„Ø¨ÙŠØ¶", fr:"El Bayadh"},
            {id:33, ar:"Ø¥Ù„ÙŠØ²ÙŠ", fr:"Illizi"}, {id:34, ar:"Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", fr:"Bordj Bou Arreridj"}, {id:35, ar:"Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", fr:"BoumerdÃ¨s"}, {id:36, ar:"Ø§Ù„Ø·Ø§Ø±Ù", fr:"El Tarf"},
            {id:37, ar:"ØªÙ†Ø¯ÙˆÙ", fr:"Tindouf"}, {id:38, ar:"ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", fr:"Tissemsilt"}, {id:39, ar:"Ø§Ù„ÙˆØ§Ø¯ÙŠ", fr:"El Oued"}, {id:40, ar:"Ø®Ù†Ø´Ù„Ø©", fr:"Khenchela"},
            {id:41, ar:"Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", fr:"Souk Ahras"}, {id:42, ar:"ØªÙŠØ¨Ø§Ø²Ø©", fr:"Tipaza"}, {id:43, ar:"Ù…ÙŠÙ„Ø©", fr:"Mila"}, {id:44, ar:"Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", fr:"AÃ¯n Defla"},
            {id:45, ar:"Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", fr:"NaÃ¢ma"}, {id:46, ar:"Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", fr:"AÃ¯n TÃ©mouchent"}, {id:47, ar:"ØºØ±Ø¯Ø§ÙŠØ©", fr:"GhardaÃ¯a"}, {id:48, ar:"ØºÙ„ÙŠØ²Ø§Ù†", fr:"Relizane"},
            {id:49, ar:"ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", fr:"Timimoun"}, {id:50, ar:"Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", fr:"Bordj Badji Mokhtar"}, {id:51, ar:"Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", fr:"Ouled Djellal"}, {id:52, ar:"Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", fr:"BÃ©ni AbbÃ¨s"},
            {id:53, ar:"Ø¥Ù† ØµØ§Ù„Ø­", fr:"In Salah"}, {id:54, ar:"Ø¥Ù† Ù‚Ø²Ø§Ù…", fr:"In Guezzam"}, {id:55, ar:"ØªÙˆÙ‚Ø±Øª", fr:"Touggourt"}, {id:56, ar:"Ø¬Ø§Ù†Øª", fr:"Djanet"},
            {id:57, ar:"Ø§Ù„Ù…ØºÙŠØ±", fr:"El M'Ghair"}, {id:58, ar:"Ø§Ù„Ù…Ù†ÙŠØ¹Ø©", fr:"El Meniaa"}
        ];

        const services = [
            {code: "srv_companion", ar: "Ù…Ø±Ø§ÙÙ‚", fr: "Accompagnateur"},
            {code: "srv_lessons", ar: "Ø¯Ø±ÙˆØ³ Ø®ØµÙˆØµÙŠØ©", fr: "Cours particuliers"},
            {code: "srv_nursery", ar: "Ø­Ø¶Ø§Ù†Ø© Ù…Ù†Ø²Ù„ÙŠØ©", fr: "Garde Ã  domicile"},
            {code: "srv_psych", ar: "Ø§Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ", fr: "Psychologue"},
            {code: "srv_speech", ar: "Ø§Ø®ØµØ§Ø¦ÙŠ Ù†Ø·Ù‚", fr: "Orthophoniste"}
        ];

        // --- TRANSLATION DICTIONARY ---
        const translations = {
            ar: {
                app_name: "Ù…Ø±Ø§ÙÙ‚", slogan: "Ø·ÙÙ„Ùƒ ÙÙŠ Ø£ÙŠØ§Ø¯ÙŠ Ø¢Ù…Ù†Ø©", login: "Ø¯Ø®ÙˆÙ„", register: "Ø¬Ø¯ÙŠØ¯", settings: "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", logout: "Ø®Ø±ÙˆØ¬",
                email_placeholder: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", password_placeholder: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", forgot_password: "Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ", login_btn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                demo_accounts: "Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„ØªØ¬Ø±Ø¨Ø©:", role_parent: "ÙˆÙ„ÙŠ Ø£Ù…Ø±", role_caregiver: "Ù…Ø±Ø§ÙÙ‚Ø©", fullname: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
                select_wilaya: "Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©", upload_cert: "Ø±ÙØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (PDF)", create_account_btn: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
                search_title: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø§ÙÙ‚Ø©", all_wilayas: "ÙƒÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª", all_services: "ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª", child_age: "Ø¹Ù…Ø± Ø§Ù„Ø·ÙÙ„", search_btn: "Ø¨Ø­Ø«",
                my_requests: "Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©", th_caregiver: "Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø©", th_service: "Ø§Ù„Ø®Ø¯Ù…Ø©", th_status: "Ø§Ù„Ø­Ø§Ù„Ø©", th_action: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
                edit: "ØªØ¹Ø¯ÙŠÙ„", incoming_requests: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", th_parent: "Ø§Ù„ÙˆÙ„ÙŠ", th_child: "Ø§Ù„Ø·ÙÙ„", th_details: "Ø§Ù„ØªÙØ§ØµÙŠÙ„", th_days: "Ø§Ù„Ø£ÙŠØ§Ù…",
                admin_panel: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", stat_users: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", stat_caregivers: "Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª", stat_reports: "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰",
                manage_users: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", search_placeholder: "Ø¨Ø­Ø«...", th_name: "Ø§Ù„Ø§Ø³Ù…", th_role: "Ø§Ù„Ù†ÙˆØ¹", 
                reports_messages: "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„", sender: "Ø§Ù„Ù…Ø±Ø³Ù„", type: "Ø§Ù„Ù†ÙˆØ¹", message: "Ø§Ù„Ø±Ø³Ø§Ù„Ø©", date: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
                about_us: "Ù…Ù† Ù†Ø­Ù†", privacy_policy: "Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©", contact_us: "ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§", report_issue: "Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©", copyright: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024",
                about_text: "Ù…Ù†ØµØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø±Ù‚Ù…ÙŠØ© ØªÙ‡Ø¯Ù Ø¥Ù„Ù‰ Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø¨ÙŠØ§Øª ÙˆØ£Ø®ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø·Ù‚ØŒ Ù„Ø¶Ù…Ø§Ù† Ø±Ø§Ø­Ø© ÙˆØ³Ù„Ø§Ù…Ø© Ø£Ø·ÙØ§Ù„ÙƒÙ….",
                privacy_text: "Ù†Ø­Ù† Ù†Ø­ØªØ±Ù… Ø®ØµÙˆØµÙŠØªÙƒÙ…. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†.",
                name: "Ø§Ù„Ø§Ø³Ù…", send: "Ø¥Ø±Ø³Ø§Ù„", issue_details: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©", send_report: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº", recover_pass: "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", recover_hint: "Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.",
                request_service: "ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©", child_name: "Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„", duration: "Ø§Ù„Ù…Ø¯Ø©", "1_month": "Ø´Ù‡Ø±", "3_months": "3 Ø£Ø´Ù‡Ø±", "1_year": "Ø³Ù†Ø©", days: "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©", confirm_send: "ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„",
                edit_profile: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„", wilaya: "Ø§Ù„ÙˆÙ„Ø§ÙŠØ©", change_pass: "ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", pro_info: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù†ÙŠØ©", save: "Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª",
                rate_caregiver: "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø©", publish: "Ù†Ø´Ø±", reviews: "Ø§Ù„Ø¢Ø±Ø§Ø¡",
                status_pending: "Ø§Ù†ØªØ¸Ø§Ø±", status_accepted: "Ù…Ù‚Ø¨ÙˆÙ„", status_rejected: "Ù…Ø±ÙÙˆØ¶", new: "Ø¬Ø¯ÙŠØ¯",
                role_admin: "Ù…Ø³Ø¤ÙˆÙ„", role_parent_label: "ÙˆÙ„ÙŠ", role_caregiver_label: "Ù…Ø±Ø§ÙÙ‚Ø©", active: "Ù†Ø´Ø·", banned: "Ù…Ø­Ø¸ÙˆØ±", ban: "Ø­Ø¸Ø±", unban: "ÙÙƒ Ø§Ù„Ø­Ø¸Ø±",
                alert_success: "Ù†Ø¬Ø§Ø­", alert_error: "Ø®Ø·Ø£", alert_sent: "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„",
                stat_total_req: "Ø§Ù„ÙƒÙ„", stat_new_req: "Ø¬Ø¯ÙŠØ¯", stat_accepted: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", stat_rejected: "Ù…Ø±ÙÙˆØ¶Ø©",
                status_online: "Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©", status_offline: "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©",
                daily_transactions: "Ø§Ù„ØªØ¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©", successful_caregivers: "Ø£Ù†Ø¬Ø­ Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª"
            },
            fr: {
                app_name: "Morafik", slogan: "Votre enfant entre de bonnes mains", login: "Connexion", register: "Nouveau", settings: "ParamÃ¨tres", logout: "DÃ©connexion",
                email_placeholder: "Adresse email", password_placeholder: "Mot de passe", forgot_password: "Mot de passe oubliÃ© ?", login_btn: "Se connecter",
                demo_accounts: "Comptes dÃ©mo:", role_parent: "Parent", role_caregiver: "Nounou", fullname: "Nom complet", phone: "TÃ©lÃ©phone",
                select_wilaya: "Choisir Wilaya", upload_cert: "DiplÃ´me (PDF)", create_account_btn: "CrÃ©er compte",
                search_title: "Trouver une nounou", all_wilayas: "Toutes Wilayas", all_services: "Tous Services", child_age: "Ã‚ge enfant", search_btn: "Rechercher",
                my_requests: "Mes demandes", th_caregiver: "Nounou", th_service: "Service", th_status: "Statut", th_action: "Action",
                edit: "Modifier", incoming_requests: "Demandes reÃ§ues", th_parent: "Parent", th_child: "Enfant", th_details: "DÃ©tails", th_days: "Jours",
                admin_panel: "Panneau Admin", stat_users: "Utilisateurs", stat_caregivers: "Nounous", stat_reports: "Signalements",
                manage_users: "GÃ©rer utilisateurs", search_placeholder: "Rechercher...", th_name: "Nom", th_role: "RÃ´le",
                reports_messages: "Signalements & Messages", sender: "ExpÃ©diteur", type: "Type", message: "Message", date: "Date",
                about_us: "Ã€ propos", privacy_policy: "ConfidentialitÃ©", contact_us: "Contactez-nous", report_issue: "Signaler problÃ¨me", copyright: "Tous droits rÃ©servÃ©s Â© 2024",
                about_text: "Plateforme numÃ©rique algÃ©rienne reliant les parents aux meilleures nounous et orthophonistes pour assurer la sÃ©curitÃ© de vos enfants.",
                privacy_text: "Nous respectons votre vie privÃ©e. Toutes les donnÃ©es saisies sont stockÃ©es en toute sÃ©curitÃ©.",
                name: "Nom", send: "Envoyer", issue_details: "DÃ©tails du problÃ¨me", send_report: "Envoyer signalement", recover_pass: "RÃ©cupÃ©rer mot de passe", recover_hint: "Entrez votre email.",
                request_service: "Demander service", child_name: "Nom de l'enfant", duration: "DurÃ©e", "1_month": "1 mois", "3_months": "3 mois", "1_year": "1 an", days: "Jours prÃ©fÃ©rÃ©s", confirm_send: "Confirmer",
                edit_profile: "Modifier profil", wilaya: "Wilaya", change_pass: "Changer mot de passe", pro_info: "Infos pro", save: "Enregistrer",
                rate_caregiver: "Noter la nounou", publish: "Publier", reviews: "Avis",
                status_pending: "En attente", status_accepted: "AcceptÃ©", status_rejected: "RefusÃ©", new: "Nouveau",
                role_admin: "Admin", role_parent_label: "Parent", role_caregiver_label: "Nounou", active: "Actif", banned: "Banni", ban: "Bannir", unban: "DÃ©bannir",
                alert_success: "SuccÃ¨s", alert_error: "Erreur", alert_sent: "EnvoyÃ©",
                stat_total_req: "Total", stat_new_req: "Nouveau", stat_accepted: "AcceptÃ©", stat_rejected: "RefusÃ©",
                status_online: "En Service", status_offline: "Hors Service",
                daily_transactions: "Transactions du Jour", successful_caregivers: "Top Nounous"
            }
        };

        // Populate translations with dynamic lists (Wilayas & Services)
        wilayas.forEach(w => {
            translations.ar[`w_${w.id}`] = w.ar;
            translations.fr[`w_${w.id}`] = w.fr;
        });
        services.forEach(s => {
            translations.ar[s.code] = s.ar;
            translations.fr[s.code] = s.fr;
        });

        let currentLang = 'ar';
        function t(key) { return translations[currentLang][key] || key; }

        function populateDropdowns() {
            // Populate Wilayas
            const wSelects = document.querySelectorAll('.dynamic-wilaya');
            wSelects.forEach(sel => {
                const isSearch = sel.id === 'searchWilaya';
                let html = isSearch ? `<option value="Ø§Ù„ÙƒÙ„" data-i18n="all_wilayas">${t('all_wilayas')}</option>` : `<option value="" disabled selected data-i18n="select_wilaya">${t('select_wilaya')}</option>`;
                wilayas.forEach(w => {
                    html += `<option value="${w.ar}" data-i18n="w_${w.id}">${currentLang === 'ar' ? w.ar : w.fr}</option>`;
                });
                sel.innerHTML = html;
            });

            // Populate Services
            const sSelects = document.querySelectorAll('.dynamic-service');
            sSelects.forEach(sel => {
                const isSearch = sel.id === 'searchService';
                let html = isSearch ? `<option value="Ø§Ù„ÙƒÙ„" data-i18n="all_services">${t('all_services')}</option>` : '';
                services.forEach(s => {
                    html += `<option value="${s.ar}" data-i18n="${s.code}">${currentLang === 'ar' ? s.ar : s.fr}</option>`;
                });
                sel.innerHTML = html;
            });
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'fr' : 'ar';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('langSwitcher').innerText = currentLang === 'ar' ? 'FR' : 'AR';
            
            // Text Content
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t(el.getAttribute('data-i18n')));
            // Placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
            
            // Update Options Text (keeping value)
            document.querySelectorAll('option').forEach(opt => {
                const key = opt.getAttribute('data-i18n');
                if(key) opt.innerText = t(key);
            });

            if(currentUser) {
                if(currentUser.role === 'parent') { performSearch(); loadMyRequests(); }
                else if(currentUser.role === 'caregiver') { loadCaregiverDashboard(); }
                else if(currentUser.role === 'admin') { loadAdminDashboard(); }
            }
        }

        const Toast = Swal.mixin({ toast: true, position: 'top-start', showConfirmButton: false, timer: 3000 });
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/4042/4042356.png";
        
        // --- DATA ---
        const initialUsers = [
            { id: 'c1', name: 'Ø³Ø§Ø±Ø© Ù…Ø­Ù…Ø¯', email: 'nounou@test.com', pass: '123', role: 'caregiver', phone: '0550112233', wilaya: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', service: 'Ø­Ø¶Ø§Ù†Ø© Ù…Ù†Ø²Ù„ÙŠØ©', hasCert: true, photo: defaultAvatar, isBanned: false, isAvailable: true, createdAt: '2023-10-01' },
            { id: 'p1', name: 'Ø£Ø­Ù…Ø¯ Ø§Ù„ÙˆÙ„ÙŠ', email: 'parent@test.com', pass: '123', role: 'parent', phone: '0555000000', wilaya: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', photo: defaultAvatar, isBanned: false, createdAt: '2024-01-20' }
        ];

        if (!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify(initialUsers));
        if (!localStorage.getItem('requests')) localStorage.setItem('requests', JSON.stringify([]));
        if (!localStorage.getItem('reviews')) localStorage.setItem('reviews', JSON.stringify([]));
        if (!localStorage.getItem('reports')) localStorage.setItem('reports', JSON.stringify([]));

        const DB = {
            getUsers: () => JSON.parse(localStorage.getItem('users')),
            saveUser: (user) => { const u = DB.getUsers(); u.push(user); localStorage.setItem('users', JSON.stringify(u)); },
            saveAllUsers: (users) => { localStorage.setItem('users', JSON.stringify(users)); },
            updateUser: (updatedUser) => { const users = DB.getUsers(); const idx = users.findIndex(u => u.id === updatedUser.id); if(idx !== -1) { users[idx] = updatedUser; localStorage.setItem('users', JSON.stringify(users)); return true; } return false; },
            getRequests: () => JSON.parse(localStorage.getItem('requests')),
            saveRequest: (req) => { const r = DB.getRequests(); r.push(req); localStorage.setItem('requests', JSON.stringify(r)); },
            updateRequestStatus: (reqId, status) => { const r = DB.getRequests(); const idx = r.findIndex(x => x.id == reqId); if (idx !== -1) { r[idx].status = status; localStorage.setItem('requests', JSON.stringify(r)); } },
            getReviews: () => JSON.parse(localStorage.getItem('reviews')),
            saveReview: (review) => { const r = DB.getReviews(); r.push(review); localStorage.setItem('reviews', JSON.stringify(r)); },
            getReports: () => JSON.parse(localStorage.getItem('reports')),
            saveReport: (rep) => { const r = DB.getReports(); r.push(rep); localStorage.setItem('reports', JSON.stringify(r)); }
        };

        let currentUser = null;

        // --- CORE FUNCTIONS ---
        function switchView(viewId) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.getElementById(viewId).classList.add('active'); window.scrollTo(0,0); }
        function openModal(id) { new bootstrap.Modal(document.getElementById(id)).show(); }
        window.selectRole = (role, elem) => { document.querySelectorAll('.role-selector').forEach(el => el.classList.remove('active')); elem.classList.add('active'); document.getElementById('regRole').value = role; role === 'caregiver' ? document.getElementById('caregiverFields').classList.remove('d-none') : document.getElementById('caregiverFields').classList.add('d-none'); };
        function logout() { currentUser = null; switchView('authView'); document.getElementById('logoutBtn').classList.add('d-none'); document.getElementById('editProfileBtn').classList.add('d-none'); document.getElementById('userInfo').innerText = ''; document.getElementById('loginForm').reset(); }

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value; const pass = document.getElementById('loginPass').value;
            if(email === 'admin' && pass === 'abobob123') { currentUser = { name: 'Admin', role: 'admin' }; document.getElementById('logoutBtn').classList.remove('d-none'); document.getElementById('userInfo').innerText = t('role_admin'); loadAdminDashboard(); switchView('adminView'); return; }
            const user = DB.getUsers().find(u => u.email === email && u.pass === pass);
            if (user) { 
                if(user.isBanned) { Swal.fire({ icon: 'error', title: t('banned') }); return; }
                currentUser = user; document.getElementById('logoutBtn').classList.remove('d-none'); document.getElementById('editProfileBtn').classList.remove('d-none'); document.getElementById('userInfo').innerText = user.name;
                user.role === 'parent' ? (switchView('parentView'), performSearch(), loadMyRequests()) : (switchView('caregiverView'), loadCaregiverDashboard());
            } else { Toast.fire({ icon: 'error', title: t('alert_error') }); }
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const role = document.getElementById('regRole').value;
            const newUser = { id: 'u' + Date.now(), name: document.getElementById('regName').value, email: document.getElementById('regEmail').value, phone: document.getElementById('regPhone').value, pass: document.getElementById('regPass').value, role: role, wilaya: document.getElementById('regWilaya').value, photo: defaultAvatar, isBanned: false, isAvailable: true, createdAt: new Date().toISOString().split('T')[0] };
            if (role === 'caregiver') { newUser.service = document.getElementById('regService').value; newUser.hasCert = true; }
            DB.saveUser(newUser); Toast.fire({ icon: 'success', title: t('alert_success') });
            document.querySelector('[data-bs-target="#login-content"]').click(); document.getElementById('registerForm').reset();
        });

        // --- FORGOT PASS / REPORT ---
        function openForgotPassModal() { new bootstrap.Modal(document.getElementById('forgotPassModal')).show(); }
        function handleForgotPass() { bootstrap.Modal.getInstance(document.getElementById('forgotPassModal')).hide(); Swal.fire({ icon: 'info', title: t('alert_sent'), text: 'Check Admin Panel' }); }
        function submitReport(e, type) { e.preventDefault(); DB.saveReport({ sender: currentUser ? currentUser.name : 'Visitor', type, message: e.target.querySelector('textarea').value, date: new Date().toLocaleDateString() }); bootstrap.Modal.getInstance(e.target.closest('.modal')).hide(); e.target.reset(); Swal.fire({ icon: 'success', title: t('alert_sent') }); }

        // --- PARENT ---
        function performSearch() {
            const wilaya = document.getElementById('searchWilaya').value; const service = document.getElementById('searchService').value;
            const container = document.getElementById('resultsArea'); container.innerHTML = '';
            const filtered = DB.getUsers().filter(u => u.role === 'caregiver' && !u.isBanned && u.isAvailable === true && (wilaya === 'Ø§Ù„ÙƒÙ„' || u.wilaya === wilaya) && (service === 'Ø§Ù„ÙƒÙ„' || u.service === service));
            
            if (filtered.length === 0) { container.innerHTML = `<div class="col-12 text-center text-muted py-4">${t('status_pending')}...</div>`; return; }
            filtered.forEach(c => {
                const reviews = DB.getReviews().filter(r => r.caregiverId === c.id);
                const avg = reviews.length ? (reviews.reduce((a,b)=>a+b.stars,0)/reviews.length).toFixed(1) : 0;
                let stars = ''; for(let i=1;i<=5;i++) stars += i<=Math.round(avg)?'<i class="bi bi-star-fill text-warning"></i>':'<i class="bi bi-star text-muted"></i>';
                
                // Lookup Display Values
                const displayService = services.find(s=>s.ar === c.service);
                const displayWilaya = wilayas.find(w=>w.ar === c.wilaya);
                const sText = displayService ? (currentLang==='ar'?displayService.ar:displayService.fr) : c.service;
                const wText = displayWilaya ? (currentLang==='ar'?displayWilaya.ar:displayWilaya.fr) : c.wilaya;

                container.innerHTML += `<div class="col-md-6 col-lg-4"><div class="custom-card p-3 h-100 text-center"><img src="${c.photo}" class="profile-img-preview mx-auto mb-2"><h5 class="fw-bold mb-1">${c.name}</h5><div class="mb-2" onclick="showReviews('${c.id}')" style="cursor:pointer">${stars} <span class="small">(${avg})</span></div><p class="small text-muted mb-2">${sText} | ${wText}</p><button class="btn btn-outline-primary w-100 fw-bold mt-auto" onclick="openRequestModal('${c.id}')">${t('request_service')}</button></div></div>`;
            });
        }
        window.openRequestModal = (id) => { document.getElementById('targetCaregiverId').value = id; new bootstrap.Modal(document.getElementById('requestModal')).show(); };
        document.getElementById('sendRequestForm').addEventListener('submit', (e) => { e.preventDefault(); DB.saveRequest({ id: Date.now(), parentId: currentUser.id, parentName: currentUser.name, parentPhone: currentUser.phone, caregiverId: document.getElementById('targetCaregiverId').value, childName: document.getElementById('reqChildName').value, childAge: document.getElementById('reqChildAge').value, serviceType: 'Service', days: document.getElementById('reqDays').value, duration: document.getElementById('reqDuration').value, status: 'pending', isRated: false }); bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide(); Swal.fire({ icon: 'success', title: t('alert_sent') }); loadMyRequests(); });
        function loadMyRequests() {
            const tbody = document.getElementById('myRequestsTable'); tbody.innerHTML = '';
            DB.getRequests().filter(r => r.parentId === currentUser.id).forEach(r => {
                const cg = DB.getUsers().find(u => u.id === r.caregiverId) || {name: '?'};
                let status = r.status === 'pending' ? `<span class="badge bg-warning text-dark">${t('status_pending')}</span>` : r.status === 'accepted' ? `<span class="badge bg-success">${t('status_accepted')}</span>` : `<span class="badge bg-danger">${t('status_rejected')}</span>`;
                let action = r.status === 'accepted' ? `<a href="tel:${cg.phone}" class="btn btn-sm btn-success rounded-pill"><i class="bi bi-phone"></i></a>` : '-';
                if(r.status === 'accepted' && !r.isRated) action += ` <button class="btn btn-sm btn-warning rounded-pill" onclick="openRateModal('${r.id}','${cg.id}','${cg.name}')"><i class="bi bi-star"></i></button>`;
                tbody.innerHTML += `<tr><td data-label="${t('th_caregiver')}">${cg.name}</td><td data-label="${t('th_service')}">${r.childName}</td><td data-label="${t('th_status')}">${status}</td><td data-label="${t('th_action')}">${action}</td></tr>`;
            });
        }

        // --- CAREGIVER DASHBOARD & STATS ---
        function loadCaregiverDashboard() {
            document.getElementById('dashboardProfileImg').src = currentUser.photo; document.getElementById('cgNameProfile').innerText = currentUser.name;
            document.getElementById('cgWilayaProfile').innerText = currentUser.wilaya; document.getElementById('cgServiceProfile').innerText = currentUser.service;
            const toggle = document.getElementById('availabilityToggle'); const label = document.getElementById('availabilityLabel'); toggle.checked = currentUser.isAvailable !== false;
            label.innerText = toggle.checked ? t('status_online') : t('status_offline'); label.className = toggle.checked ? 'form-check-label fw-bold small text-success' : 'form-check-label fw-bold small text-danger';
            const reqs = DB.getRequests().filter(r => r.caregiverId === currentUser.id);
            document.getElementById('cgStatTotal').innerText = reqs.length; document.getElementById('cgStatPending').innerText = reqs.filter(r => r.status === 'pending').length; document.getElementById('cgStatAccepted').innerText = reqs.filter(r => r.status === 'accepted').length; document.getElementById('cgStatRejected').innerText = reqs.filter(r => r.status === 'rejected').length;
            const tbody = document.getElementById('incomingRequestsTable'); tbody.innerHTML = '';
            reqs.forEach(r => {
                let action = r.status === 'pending' ? `<button class="btn btn-sm btn-success" onclick="handleReq(${r.id},'accepted')">âœ”</button> <button class="btn btn-sm btn-danger" onclick="handleReq(${r.id},'rejected')">âœ˜</button>` : (r.status === 'accepted' ? t('status_accepted') : t('status_rejected'));
                let pInfo = r.status === 'accepted' ? `${r.parentName}<br><a href="tel:${r.parentPhone}" class="small">${r.parentPhone}</a>` : r.parentName;
                tbody.innerHTML += `<tr><td data-label="${t('th_parent')}">${pInfo}</td><td data-label="${t('th_child')}">${r.childName}</td><td data-label="${t('th_details')}">${r.duration}</td><td data-label="${t('th_days')}">${r.days}</td><td data-label="${t('th_action')}">${action}</td></tr>`;
            });
        }
        function toggleAvailability() { const toggle = document.getElementById('availabilityToggle'); currentUser.isAvailable = toggle.checked; DB.updateUser(currentUser); loadCaregiverDashboard(); }
        window.handleReq = (id, s) => { DB.updateRequestStatus(id, s); loadCaregiverDashboard(); };

        // --- REVIEWS ---
        window.showReviews = (cid) => {
            const body = document.getElementById('reviewsListBody'); body.innerHTML = ''; const revs = DB.getReviews().filter(r => r.caregiverId === cid);
            if(!revs.length) body.innerHTML = t('new');
            revs.forEach(r => body.innerHTML += `<div class="review-card"><strong>${r.parentName}</strong> (${r.stars}â˜…)<p class="mb-0 small">${r.comment}</p></div>`);
            new bootstrap.Modal(document.getElementById('reviewsListModal')).show();
        };
        window.openRateModal = (rid, cid, name) => { document.getElementById('rateRequestId').value = rid; document.getElementById('rateCaregiverId').value = cid; document.getElementById('rateCgName').innerText = name; new bootstrap.Modal(document.getElementById('rateModal')).show(); };
        window.submitReview = () => {
            const rid = document.getElementById('rateRequestId').value; DB.saveReview({ id: Date.now(), caregiverId: document.getElementById('rateCaregiverId').value, parentName: currentUser.name, stars: document.getElementById('ratingValue').value, comment: document.getElementById('rateComment').value });
            const rs = DB.getRequests(); rs.find(r=>r.id==rid).isRated = true; localStorage.setItem('requests', JSON.stringify(rs));
            bootstrap.Modal.getInstance(document.getElementById('rateModal')).hide(); Swal.fire({ icon: 'success' }); loadMyRequests();
        };
        document.querySelectorAll('#starContainer i').forEach(star => star.addEventListener('click', function(){ const v = this.getAttribute('data-val'); document.getElementById('ratingValue').value = v; document.querySelectorAll('#starContainer i').forEach(s => s.classList.toggle('text-warning', s.getAttribute('data-val')<=v)); }));

        // --- ADMIN ---
        function loadAdminDashboard() {
            const users = DB.getUsers(); 
            const reports = DB.getReports();
            
            // Basic Stats
            document.getElementById('statTotalUsers').innerText = users.length; 
            document.getElementById('statCaregivers').innerText = users.filter(u=>u.role==='caregiver').length; 
            document.getElementById('statReportsCount').innerText = reports.length;
            
            // --- NEW: Daily Transactions (Last 10 Requests) ---
            const allReqs = DB.getRequests().sort((a,b) => b.id - a.id).slice(0, 10);
            const transTable = document.getElementById('adminDailyTrans');
            transTable.innerHTML = '';
            if(allReqs.length === 0) transTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted small">No data</td></tr>';
            
            allReqs.forEach(r => {
                const cg = users.find(u => u.id === r.caregiverId) || {name: 'Unknown'};
                let statusBadge = r.status === 'accepted' ? '<span class="badge bg-success">âœ”</span>' : 
                                  (r.status === 'rejected' ? '<span class="badge bg-danger">âœ˜</span>' : '<span class="badge bg-warning">â³</span>');
                transTable.innerHTML += `<tr><td><span class="small fw-bold">${r.parentName}</span></td><td><span class="small">${cg.name}</span></td><td>${statusBadge}</td></tr>`;
            });

            // --- NEW: Successful Caregivers ---
            const successCounts = {};
            DB.getRequests().filter(r => r.status === 'accepted').forEach(r => {
                successCounts[r.caregiverId] = (successCounts[r.caregiverId] || 0) + 1;
            });
            
            const topCgs = Object.keys(successCounts).map(id => {
                const user = users.find(u => u.id === id);
                return user ? { ...user, count: successCounts[id] } : null;
            }).filter(u => u).sort((a, b) => b.count - a.count).slice(0, 5);

            const topTable = document.getElementById('adminTopCaregivers');
            topTable.innerHTML = '';
            if(topCgs.length === 0) topTable.innerHTML = '<tr><td class="text-muted small">No data</td></tr>';

            topCgs.forEach((c, index) => {
                let medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : ''));
                topTable.innerHTML += `
                    <tr class="border-bottom">
                        <td style="width:50px"><img src="${c.photo}" class="rounded-circle" width="40" height="40"></td>
                        <td><div class="fw-bold small">${c.name} ${medal}</div><div class="text-muted" style="font-size:0.75rem">${c.service}</div></td>
                        <td class="text-end"><span class="badge bg-primary rounded-pill">${c.count} <i class="bi bi-check-circle"></i></span></td>
                    </tr>`;
            });

            // Users Table
            const search = document.getElementById('adminSearch').value.toLowerCase(); 
            const uTable = document.getElementById('adminUsersTable'); 
            uTable.innerHTML = '';
            users.filter(u => u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search)).forEach(u => {
                const btn = u.isBanned ? `<button class="btn btn-sm btn-success" onclick="toggleBan('${u.id}')">${t('unban')}</button>` : `<button class="btn btn-sm btn-outline-danger" onclick="toggleBan('${u.id}')">${t('ban')}</button>`;
                uTable.innerHTML += `<tr><td class="fw-bold">${u.name}</td><td>${u.role==='parent'?t('role_parent_label'):t('role_caregiver_label')}</td><td>${u.phone}</td><td class="small">${u.email}</td><td class="text-danger fw-bold font-monospace">${u.pass}</td><td>${u.isBanned?`<span class="badge bg-danger">${t('banned')}</span>`:`<span class="badge bg-success">${t('active')}</span>`}</td><td>${btn}</td></tr>`;
            });
            
            // Reports Table
            const rTable = document.getElementById('adminReportsTable'); 
            rTable.innerHTML = ''; 
            reports.reverse().forEach(r => { rTable.innerHTML += `<tr><td>${r.sender}</td><td>${r.type}</td><td>${r.message}</td><td>${r.date}</td></tr>`; });
        }
        window.toggleBan = (id) => { const u=DB.getUsers(); const t=u.find(x=>x.id===id); t.isBanned=!t.isBanned; DB.saveAllUsers(u); loadAdminDashboard(); };

        // --- EDIT PROFILE ---
        document.getElementById('editProfilePic').addEventListener('change', function(e) { if (e.target.files[0]) { const r = new FileReader(); r.onload = (ev) => document.getElementById('editImgPreview').src = ev.target.result; r.readAsDataURL(e.target.files[0]); } });
        window.openEditProfileModal = () => {
            if(!currentUser) return;
            document.getElementById('editName').value = currentUser.name; document.getElementById('editPhone').value = currentUser.phone;
            document.getElementById('editWilaya').value = currentUser.wilaya; document.getElementById('editImgPreview').src = currentUser.photo;
            if(currentUser.role === 'caregiver') { document.getElementById('caregiverEditFields').classList.remove('d-none'); document.getElementById('editService').value = currentUser.service; } 
            else { document.getElementById('caregiverEditFields').classList.add('d-none'); }
            new bootstrap.Modal(document.getElementById('editProfileModal')).show();
        };
        document.getElementById('editProfileForm').addEventListener('submit', (e) => {
            e.preventDefault();
            currentUser.name = document.getElementById('editName').value; currentUser.phone = document.getElementById('editPhone').value; currentUser.wilaya = document.getElementById('editWilaya').value;
            const newPass = document.getElementById('editNewPass').value; if(newPass) currentUser.pass = newPass; 
            const img = document.getElementById('editImgPreview').src; if(img !== window.location.href) currentUser.photo = img;
            if(currentUser.role === 'caregiver') currentUser.service = document.getElementById('editService').value;
            DB.updateUser(currentUser); bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide(); Swal.fire({ icon: 'success', title: t('alert_success') });
            currentUser.role === 'parent' ? (performSearch(), switchView('parentView')) : loadCaregiverDashboard();
        });

        // Initialize Dropdowns
        populateDropdowns();
    </script>
</body>
</html>
